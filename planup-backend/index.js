const express = require('express');
const mysql = require('mysql2/promise');
const cors = require('cors');
const bcrypt = require('bcrypt');
const dbConfig = require('./config/dbConfig'); // Adatb√°zis konfigur√°ci√≥ import√°l√°sa
const programRoutes = require('./routes/programs'); 
const userRoutes = require('./routes/users');
const roomRoutes = require('./routes/rooms'); // Router import√°l√°sa
const profileRoutes = require('./routes/profiles');
const cookieParser = require("cookie-parser"); //Cookie-k kezel√©se
const session = require('express-session');
const authRoutes = require('./routes/auth');

// Az app inicializ√°l√°sa
const app = express();


require('dotenv').config();

if (!process.env.SESSION_SECRET) {
    console.error("‚ùå SESSION_SECRET nincs be√°ll√≠tva az .env f√°jlban! A szerver le√°ll.");
    process.exit(1); // Kil√©p√ºnk a szerverb≈ël
}

// API v√©gpontok regisztr√°l√°sa
app.use('/api/users', userRoutes);
app.use('/api/auth', require('./routes/auth'));
app.use('/rooms', roomRoutes);
app.use('/profile', profileRoutes);
app.use('/programs', programRoutes);



// Middleware-ek
app.use(express.json());
app.use(cookieParser());

const corsOptions = {
    origin: "http://localhost:3000", // üîπ Enged√©lyezi a frontend k√©r√©seit
    credentials: true, // üîπ Enged√©lyezi a s√ºtik k√ºld√©s√©t
    methods: "GET,HEAD,PUT,PATCH,POST,DELETE",
    allowedHeaders: "Content-Type,Authorization"
};

app.use(cors(corsOptions));

app.use((req, res, next) => {
  res.header("Access-Control-Allow-Origin", "http://localhost:3000");
  res.header("Access-Control-Allow-Credentials", "true");
  res.header("Access-Control-Allow-Methods", "GET,HEAD,PUT,PATCH,POST,DELETE");
  res.header("Access-Control-Allow-Headers", "Content-Type,Authorization");

  if (req.method === "OPTIONS") {
    return res.sendStatus(200);
}
next();
});


// üîπ Statikus f√°jlok kiszolg√°l√°sa (FONTOS!)
app.use('/images', express.static('public/images'));
app.use('/images', express.static(__dirname + '/public/images'));



// üîπ **Glob√°lisan defini√°ljuk a db v√°ltoz√≥t**
let db;

// Middleware: az adatb√°zis kapcsolat biztos√≠t√°sa minden k√©r√©shez
app.use(async (req, res, next) => {
  try {
    if (!db) {
      db = await mysql.createConnection(dbConfig);
      console.log('Adatb√°zis kapcsolat √∫jra l√©trehozva.');
    }
    req.db = db;
    next();
  } catch (err) {
    console.error('Hiba az adatb√°zis √∫jracsatlakoz√°s sor√°n:', err.message);
    res.status(500).json({ error: 'Adatb√°zis kapcsolat sikertelen.' });
  }
});


// Regisztr√°ci√≥
app.post('/auth/register', async (req, res) => {
  const { username, password, email } = req.body;

  if (!username || !password || !email) {
    return res.status(400).json({ error: 'Minden mez≈ë kit√∂lt√©se k√∂telez≈ë!' });
  }

  try {
    const hashedPassword = bcrypt.hashSync(password, 10);
    const [result] = await req.db.execute(
      'INSERT INTO Users (Username, PasswordHash, Email) VALUES (?, ?, ?)',
      [username, hashedPassword, email]
    );
    res.status(201).json({ message: 'User registered successfully', userID: result.insertId });
  } catch (error) {
    console.error('Regisztr√°ci√≥s hiba:', error.message);
    res.status(500).json({ error: 'Failed to register user', details: error.message });
  }
});



// Teszt √∫tvonal
app.get('/', (req, res) => {
  res.send('Express.js backend m≈±k√∂dik!');
});

// Szerver ind√≠t√°sa
const PORT = 3001;
app.listen(PORT, () => {
  console.log(`Szerver fut a http://localhost:${PORT} c√≠men`);
});

// üîπ Program funkci√≥k
app.get('/programs', async (req, res) => {
  const { cost, duration } = req.query;

  let query = "SELECT ProgramID, Name, Description, Duration, Cost, Location, Image FROM Programs WHERE 1=1";
const params = [];

if (cost !== undefined) {
  query += " AND Cost = ?";
  params.push(cost === 'true' ? 1 : 0);
}

if (duration !== undefined) {
  query += " AND Duration = ?";
  params.push(parseInt(duration, 10));
}


  try {
    const [programs] = await req.db.execute(query, params);

    const formattedPrograms = programs.map(prog => ({
      ...prog,
      Cost: Boolean(prog.Cost),
      Image: prog.Image.startsWith('/images/') ? prog.Image : `/images/${prog.Image}` // Helyes k√©p√∫tvonal biztos√≠t√°sa
    }));

    res.status(200).json(formattedPrograms);
  } catch (error) {
    console.error('Hiba t√∂rt√©nt a programok sz≈±r√©se sor√°n:', error.message);
    res.status(500).json({ error: 'Hiba t√∂rt√©nt a programok sz≈±r√©se sor√°n.' });
  }
});

// üîπ V√©letlenszer≈± program lek√©r√©se

app.get("/programs/random", async (req, res) => {
  const { userId } = req.query;

  if (!userId) {
    console.error("‚ùå Hi√°nyz√≥ userId param√©ter!");
    return res.status(400).json({ error: "Hi√°nyz√≥ userId param√©ter." });
  }

  try {
    console.log(`üîç Random program lek√©r√©se UserID = ${userId}`);

    // Lek√©rdezz√ºk az √∂sszes programot, amit a felhaszn√°l√≥ m√°r like-olt
    const [likedPrograms] = await db.execute(
      "SELECT ProgramID FROM UserLikes WHERE UserID = ?",
      [userId]
    );

    const likedProgramIds = likedPrograms.map(p => p.ProgramID);

    // Ha nincs liked program, akkor egyszer≈± random programot v√°lasztunk
    let sqlQuery = `SELECT * FROM Programs WHERE ProgramID NOT IN (?) ORDER BY RAND() LIMIT 1`;
    let queryParams = [likedProgramIds.length > 0 ? likedProgramIds : [-1]];

    if (likedProgramIds.length === 0) {
      sqlQuery = `SELECT * FROM Programs ORDER BY RAND() LIMIT 1`;
      queryParams = [];
    }

    const [randomProgram] = await db.execute(sqlQuery, queryParams);

    if (randomProgram.length === 0) {
      console.log("‚ö†Ô∏è Nincs t√∂bb el√©rhet≈ë program.");
      return res.json(null); // Ha nincs t√∂bb program, k√ºldj√∂n √ºres v√°laszt
    }

    console.log("üéØ Visszak√ºld√∂tt random program:", randomProgram[0].Name, `(ID: ${randomProgram[0].ProgramID})`);
    res.json(randomProgram[0]);

  } catch (error) {
    console.error("üî• Hiba t√∂rt√©nt a random program lek√©r√©sekor:", error);
    res.status(500).json({ error: "Szerverhiba a program bet√∂lt√©sekor." });
  }
});


// üîπ Program kedvel√©se   
app.post("/programs/:programId/like", async (req, res) => {
  const { programId } = req.params;
  const { userId } = req.body;

  if (!userId || !programId) {
    console.error("‚ùå Hi√°nyz√≥ userId vagy programId a like k√©r√©sben!");
    return res.status(400).json({ error: "Hi√°nyz√≥ userId vagy programId." });
  }

  try {
    console.log(`üîç Like k√©r√©s be√©rkezett: UserID = ${userId}, ProgramID = ${programId}`);

    // Ellen≈ërizz√ºk, hogy a user m√°r like-olta-e ezt a programot
    const [existingLike] = await db.execute(
      "SELECT * FROM UserLikes WHERE UserID = ? AND ProgramID = ?",
      [userId, programId]
    );

    if (existingLike.length > 0) {
      console.log(`‚ö†Ô∏è UserID (${userId}) m√°r like-olta ezt a programot (ProgramID: ${programId})`);
      return res.status(400).json({ error: "A program m√°r like-olva van." });
    }

    // Like ment√©se az adatb√°zisba
    await db.execute("INSERT INTO UserLikes (UserID, ProgramID) VALUES (?, ?)", [userId, programId]);

    console.log(`üëç Program (${programId}) sikeresen like-olva UserID (${userId}) √°ltal`);

    res.json({ success: true, message: "Program sikeresen like-olva." });
  } catch (error) {
    console.error("üî• Hiba t√∂rt√©nt a like ment√©sekor:", error);
    res.status(500).json({ error: "Szerverhiba a like ment√©sekor." });
  }
});



// üîπ Program elutas√≠t√°sa
app.post('/programs/:id/dislike', async (req, res) => {
  const { id } = req.params;
  const { userId } = req.body;

  if (!userId) {
    return res.status(400).json({ error: 'UserID sz√ºks√©ges!' });
  }

  try {
    await req.db.execute('INSERT INTO SwipeActions (UserID, ProgramID, Action) VALUES (?, ?, "dislike")', [userId, id]);
    res.status(200).json({ message: 'A program sikeresen nem kedvelt.' });
  } catch (error) {
    console.error('Nem kedvel√©si hiba:', error.message);
    res.status(500).json({ error: 'Hiba t√∂rt√©nt a program nem kedvel√©se sor√°n.' });
  }
});

// üîπ √ñsszegz√©s
app.get("/programs/liked", async (req, res) => {
  const { userId } = req.query;

  if (!userId) {
    console.error("‚ùå Hi√°nyz√≥ userId param√©ter!");
    return res.status(400).json({ error: "Hi√°nyz√≥ userId param√©ter." });
  }

  console.log(`üîç Akt√≠v felhaszn√°l√≥ ID: ${userId}`);

  try {
    const [likedPrograms] = await db.execute(`
      SELECT p.*, COUNT(ul.ProgramID) AS LikesCount
      FROM Programs p
      JOIN UserLikes ul ON p.ProgramID = ul.ProgramID
      WHERE ul.UserID = ?
      GROUP BY p.ProgramID
      ORDER BY LikesCount DESC
    `, [userId]);

    console.log("‚úÖ Lek√©rdezett kedvelt programok:", likedPrograms);
    res.json(likedPrograms);
  } catch (error) {
    console.error("üî• Hiba t√∂rt√©nt a kedvelt programok lek√©r√©sekor:", error);
    res.status(500).json({ error: "Szerverhiba a kedvelt programok bet√∂lt√©sekor." });
  }
});

//Liked program reset
app.delete("/programs/liked/reset", async (req, res) => {
  const { userId } = req.body; // Fontos: req.body-b√≥l kapjuk az adatokat!
  
  if (!userId) return res.status(400).json({ error: "Hi√°nyz√≥ userId!" });

  try {
    await db.query("DELETE FROM UserLikes WHERE UserID = ?", [userId]);
    res.status(200).json({ message: "Kedvelt programok t√∂r√∂lve." });
  } catch (err) {
    console.error("Hiba:", err);
    res.status(500).json({ error: "Hiba t√∂rt√©nt a t√∂rl√©s sor√°n." });
  }
});



//Rooms API UserID cuccok

// CORS be√°ll√≠t√°s, hogy a frontend el√©rhesse a szervert
app.use(cors({
  origin: "http://localhost:3000",
  credentials: true
}));
app.use(express.json());
app.use(cookieParser());

// Session middleware be√°ll√≠t√°sa
app.use(session({
  secret: process.env.SESSION_SECRET, // Titkos kulcs be√°ll√≠t√°sa
  resave: false,
  saveUninitialized: false,
  cookie: {
      secure: false, // HTTPS eset√©n legyen true
      httpOnly: true,
      maxAge: 1000 * 60 * 60 * 24 // 1 napos lej√°rat
  }
}));

//Bejelentkez√©s API

app.post("/api/users/login", async (req, res) => {
  const { email, password } = req.body;

  if (!email || !password) {
    return res.status(400).json({ error: "Hi√°nyz√≥ adatok!" });
  }

  try {
    const [users] = await req.db.execute(
      "SELECT UserID, Email, PasswordHash FROM Users WHERE Email = ?",
      [email]
    );

    if (users.length === 0) {
      return res.status(401).json({ error: "Hib√°s bejelentkez√©si adatok!" });
    }

    const user = users[0];
    const passwordMatch = await bcrypt.compare(password, user.PasswordHash);

    if (!passwordMatch) {
      return res.status(401).json({ error: "Hib√°s jelsz√≥!" });
    }

    req.session.user = { id: user.UserID, email: user.Email };
    res.json({ message: "‚úÖ Sikeres bejelentkez√©s!", user: req.session.user });
  } catch (error) {
    console.error("üî• Bejelentkez√©si hiba:", error.message);
    res.status(500).json({ error: "Szerverhiba!" });
  }
});

// Ellen≈ërz√©s, hogy be van-e jelentkezve
app.get("/api/users/status", (req, res) => {
  if (!req.session.user) {
    return res.status(401).json({ loggedIn: false, error: "Nincs bejelentkezve!" });
  }
  res.json({ loggedIn: true, user: req.session.user });
})

// Kijelentkez√©s API
app.post("/api/users/logout", (req, res) => {
  req.session.destroy(() => {
    res.json({ message: "üëã Sikeres kijelentkez√©s!" });
  });
});

